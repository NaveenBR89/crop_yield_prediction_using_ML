{% extends "layout.html" %}
{% block title %}Model Details - Harvest Helper{% endblock %}
{% block content %}
<div class="py-12 md:py-20 bg-gray-100">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between md:items-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4 md:mb-0">Model Details & Training</h1>
            <button id="trainButton" class="w-full md:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center gap-2">
                <span id="trainSpinner" class="hidden animate-spin rounded-full h-5 w-5 border-b-2 border-white"></span>
                <span id="trainButtonText">Train All Models</span>
            </button>
        </div>

        <div id="statusMessage" class="hidden mb-6 p-4 rounded-md text-sm"></div>

        <div class="grid md:grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Crop Recommendation Model -->
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Crop Recommendation</h2>
                {% if performance.get('crop_recommendation') %}
                    <div class="space-y-2 flex-grow">
                        <p><strong>Model Type:</strong> {{ performance.crop_recommendation.model_type }}</p>
                        <p><strong>Test Accuracy:</strong> <span class="font-semibold text-green-600">{{ performance.crop_recommendation.accuracy }}</span></p>
                        <p><strong>Last Trained:</strong> {{ performance.crop_recommendation.last_trained }}</p>
                        <div class="mt-4">
                            <h4 class="font-semibold">Best Parameters:</h4>
                            <pre class="bg-gray-100 p-2 rounded text-xs mt-1 overflow-x-auto"><code>{{ performance.crop_recommendation.best_parameters | tojson(indent=2) }}</code></pre>
                        </div>
                        
                        <!-- MODIFICATION: Report Section with Toggle Button -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center">
                                <h4 class="font-semibold">Classification Report (Test Set):</h4>
                                <button class="toggle-report-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded" data-toggle-target="#crop-report-details">
                                    Show Full Report
                                </button>
                            </div>
                            <div id="crop-report-details" class="hidden mt-2">
                                <pre class="bg-gray-100 p-2 rounded text-xs mt-1 overflow-x-auto"><code>{{ performance.crop_recommendation.classification_report | tojson(indent=2) }}</code></pre>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-gray-500 my-auto text-center">No training data available. Please train the model.</p>
                {% endif %}
            </div>

            <!-- Yield Prediction Model -->
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Yield Prediction</h2>
                {% if performance.get('yield_prediction') %}
                    <div class="space-y-2 flex-grow">
                        <p><strong>Model Type:</strong> {{ performance.yield_prediction.model_type }}</p>
                        <p><strong>Test RÂ² Score:</strong> <span class="font-semibold text-green-600">{{ performance.yield_prediction.r2_score }}</span></p>
                        <p><strong>Test MAE:</strong> {{ performance.yield_prediction.mean_absolute_error }}</p>
                        <p><strong>Test RMSE:</strong> {{ performance.yield_prediction.root_mean_squared_error }}</p>
                        <p><strong>Last Trained:</strong> {{ performance.yield_prediction.last_trained }}</p>
                        <div class="mt-4">
                            <h4 class="font-semibold">Best Parameters:</h4>
                            <pre class="bg-gray-100 p-2 rounded text-xs mt-1 overflow-x-auto"><code>{{ performance.yield_prediction.best_parameters | tojson(indent=2) }}</code></pre>
                        </div>
                    </div>
                {% else %}
                     <p class="text-gray-500 my-auto text-center">No training data available. Please train the model.</p>
                {% endif %}
            </div>

            <!-- Fertilizer Recommendation Model -->
            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">Fertilizer Recommendation</h2>
                 {% if performance.get('fertilizer_recommendation') %}
                    <div class="space-y-2 flex-grow">
                        <p><strong>Model Type:</strong> {{ performance.fertilizer_recommendation.model_type }}</p>
                        <p><strong>Test Accuracy:</strong> <span class="font-semibold text-green-600">{{ performance.fertilizer_recommendation.accuracy }}</span></p>
                        <p><strong>Last Trained:</strong> {{ performance.fertilizer_recommendation.last_trained }}</p>
                        <div class="mt-4">
                            <h4 class="font-semibold">Best Parameters:</h4>
                            <pre class="bg-gray-100 p-2 rounded text-xs mt-1 overflow-x-auto"><code>{{ performance.fertilizer_recommendation.best_parameters | tojson(indent=2) }}</code></pre>
                        </div>

                        <!-- MODIFICATION: Report Section with Toggle Button -->
                        <div class="mt-4">
                            <div class="flex justify-between items-center">
                                <h4 class="font-semibold">Classification Report (Test Set):</h4>
                                <button class="toggle-report-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-2 rounded" data-toggle-target="#fertilizer-report-details">
                                    Show Full Report
                                </button>
                            </div>
                            <div id="fertilizer-report-details" class="hidden mt-2">
                                <pre class="bg-gray-100 p-2 rounded text-xs mt-1 overflow-x-auto"><code>{{ performance.fertilizer_recommendation.classification_report | tojson(indent=2) }}</code></pre>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <p class="text-gray-500 my-auto text-center">No training data available. Please train the model.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // --- NEW SCRIPT for toggling report visibility ---
    const toggleButtons = document.querySelectorAll('.toggle-report-btn');
    
    toggleButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetSelector = button.dataset.toggleTarget;
            const targetElement = document.querySelector(targetSelector);
            
            if (targetElement) {
                targetElement.classList.toggle('hidden');
                
                // Change button text based on visibility
                if (targetElement.classList.contains('hidden')) {
                    button.textContent = 'Show Full Report';
                } else {
                    button.textContent = 'Hide Report';
                }
            }
        });
    });

    // --- Existing script for the "Train All Models" button ---
    document.getElementById('trainButton').addEventListener('click', function() {
        const button = this;
        const buttonText = document.getElementById('trainButtonText');
        const spinner = document.getElementById('trainSpinner');
        const statusMessage = document.getElementById('statusMessage');

        button.disabled = true;
        buttonText.textContent = 'Training in Progress...';
        spinner.classList.remove('hidden');
        
        statusMessage.textContent = 'Model training has started. This may take several minutes. Please do not close this page.';
        statusMessage.className = 'mb-6 p-4 rounded-md bg-blue-100 text-blue-800 text-sm';
        statusMessage.classList.remove('hidden');

        fetch('/train_models', { method: 'POST' })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.message || 'Server error'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                statusMessage.textContent = 'All models trained successfully! The page will now reload to show the new details.';
                statusMessage.className = 'mb-6 p-4 rounded-md bg-green-100 text-green-800 text-sm';
                setTimeout(() => { window.location.reload(); }, 3000);
            } else {
                statusMessage.textContent = `An error occurred: ${data.message}`;
                statusMessage.className = 'mb-6 p-4 rounded-md bg-red-100 text-red-800 text-sm';
                button.disabled = false;
                buttonText.textContent = 'Train All Models';
                spinner.classList.add('hidden');
            }
        })
        .catch(error => {
            statusMessage.textContent = `A critical error occurred: ${error.message}`;
            statusMessage.className = 'mb-6 p-4 rounded-md bg-red-100 text-red-800 text-sm';
            button.disabled = false;
            buttonText.textContent = 'Train All Models';
            spinner.classList.add('hidden');
        });
    });
</script>
{% endblock %}